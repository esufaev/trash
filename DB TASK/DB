CREATE OR REPLACE FUNCTION generate_random_string()
RETURNS VARCHAR(5) AS $$
DECLARE
    result VARCHAR(5);
BEGIN
    SELECT string_agg(
        chr(
            CASE floor(random() * 3)::INT
                WHEN 0 THEN 48 + floor(random() * 10)::INT  -- Генерация 0-9
                WHEN 1 THEN 65 + floor(random() * 26)::INT  -- Генерация A-Z
                ELSE 97 + floor(random() * 26)::INT        -- Генерация a-z
            END
        ),
        ''
    ) INTO result
    FROM generate_series(1, 5); -- Генерируем 5 символов

    RETURN result;
END;
$$ LANGUAGE plpgsql;


-- Поставка (Supply)
CREATE TABLE Поставка (
    id_поставки VARCHAR(5) PRIMARY KEY DEFAULT(generate_random_string()),
    дата DATE
);

-- Поставщики (Suppliers)
CREATE TABLE Поставщики (
    id_поставщика VARCHAR(5) PRIMARY KEY DEFAULT(generate_random_string()),
    id_поставки INT REFERENCES Поставка(id_поставки),
    номер_телефона VARCHAR(100)
);

-- Товар (Goods)
CREATE TABLE Товар (
    id_товара VARCHAR(5) PRIMARY KEY DEFAULT(generate_random_string()),
    название VARCHAR(100),
    цена INTEGER
);

-- Завод (Factory)
CREATE TABLE Завод (
    id_завода VARCHAR(5) PRIMARY KEY DEFAULT(generate_random_string()),
    id_поставщика INT REFERENCES Поставщики(id_поставщика)
);

-- Добавляем внешний ключ для Товар после создания Завод
ALTER TABLE Товар
ADD COLUMN id_завода INT REFERENCES Завод(id_завода);

-- Покупатели (Customers)
CREATE TABLE Покупатели (
    id_покупателя VARCHAR(5) PRIMARY KEY DEFAULT(generate_random_string()),
    фамилия VARCHAR(50),
    имя VARCHAR(50),
    отчество VARCHAR(50)
);

-- Авто (Transport)
CREATE TABLE Авто (
    id_машины VARCHAR(5) PRIMARY KEY DEFAULT(generate_random_string()),
    номер VARCHAR(50),
    марка VARCHAR(50)
);

-- Курьеры (Couriers)
CREATE TABLE Курьеры (
    id_курьера VARCHAR(5) PRIMARY KEY DEFAULT(generate_random_string()),
    фамилия VARCHAR(50),
    имя VARCHAR(50),
    отчество VARCHAR(50),
    id_машины INT REFERENCES Авто(id_машины)
);

-- Филиал_магазина (Store Branch)
CREATE TABLE Филиал_магазина (
    id_филиала VARCHAR(5) PRIMARY KEY DEFAULT(generate_random_string()),
    название VARCHAR(100)
);

-- Заказ (Order)
CREATE TABLE Заказ (
    id_заказа VARCHAR(5) PRIMARY KEY DEFAULT(generate_random_string()),
    id_покупателя INT REFERENCES Покупатели(id_покупателя),
    id_товара INT REFERENCES Товар(id_товара),
    дата VARCHAR(11),
    id_курьера INT REFERENCES Курьеры(id_курьера)
);

-- Добавляем внешний ключ в Филиал_магазина после создания Заказ
ALTER TABLE Филиал_магазина
ADD COLUMN id_заказа INT REFERENCES Заказ(id_заказа);

-- Добавляем внешний ключ в Поставка после создания Филиал_магазина
ALTER TABLE Поставка
ADD COLUMN id_филиала INT REFERENCES Филиал_магазина(id_филиала);



SELECT generate_random_string(); --тест
